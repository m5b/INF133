
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Extension pipelining &#8212; INF 133 Fall 2023</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../../../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../../../../" id="documentation_options" src="../../../../../_static/documentation_options.js"></script>
    <script src="../../../../../_static/jquery.js"></script>
    <script src="../../../../../_static/underscore.js"></script>
    <script src="../../../../../_static/doctools.js"></script>
    <script src="../../../../../_static/clipboard.min.js"></script>
    <script src="../../../../../_static/copybutton.js"></script>
    <script src="../../../../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../../../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../../../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../../../../_static/logo_stacked.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">INF 133 Fall 2023</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../../../index.html">
                    User Interaction Software
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Assignments
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../../assignments/a0.html">
   Assignment 0
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../../assignments/a1.html">
   Assignment 1
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../../assignments/a2.html">
   Assignment 2
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../../assignments/a3.html">
   Assignment 3
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../../assignments/a4.html">
   Assignment 4
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../../assignments/a5.html">
   Assignment 5
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Weekly Notes
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../../notes/wk1.html">
   Week 1 Notes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../../notes/wk2.html">
   Week 2 Notes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../../notes/wk3.html">
   Week 3 Notes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../../notes/wk4.html">
   Week 4 Notes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../../notes/wk5.html">
   Week 5 Notes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../../notes/wk6.html">
   Week 6 Notes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../../notes/wk7.html">
   Week 7 Notes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../../notes/wk8.html">
   Week 8 Notes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../../notes/wk9.html">
   Week 9 Notes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../../notes/wk10.html">
   Week 10 Notes
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Course Resources
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../../../resources.html">
   Resources
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../../../../../_sources/reveal/node_modules/websocket-extensions/lib/pipeline/README.md"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.md</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#overview">
   Overview
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#design-goals">
   Design goals
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#solution">
   Solution
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#message-processing">
     Message processing
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#session-closing">
     Session closing
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#error-handling">
     Error handling
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#alternative-ideas">
   Alternative ideas
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#acknowledgements">
   Acknowledgements
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Extension pipelining</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#overview">
   Overview
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#design-goals">
   Design goals
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#solution">
   Solution
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#message-processing">
     Message processing
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#session-closing">
     Session closing
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#error-handling">
     Error handling
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#alternative-ideas">
   Alternative ideas
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#acknowledgements">
   Acknowledgements
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="extension-pipelining">
<h1>Extension pipelining<a class="headerlink" href="#extension-pipelining" title="Permalink to this headline">#</a></h1>
<p><code class="docutils literal notranslate"><span class="pre">websocket-extensions</span></code> models the extension negotiation and processing pipeline
of the WebSocket protocol. Between the driver parsing messages from the TCP
stream and handing those messages off to the application, there may exist a
stack of extensions that transform the message somehow.</p>
<p>In the parlance of this framework, a <em>session</em> refers to a single instance of an
extension, acting on a particular socket on either the server or the client
side. A session may transform messages both incoming to the application and
outgoing from the application, for example the <code class="docutils literal notranslate"><span class="pre">permessage-deflate</span></code> extension
compresses outgoing messages and decompresses incoming messages. Message streams
in either direction are independent; that is, incoming and outgoing messages
cannot be assumed to ‘pair up’ as in a request-response protocol.</p>
<p>Asynchronous processing of messages poses a number of problems that this
pipeline construction is intended to solve.</p>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">#</a></h2>
<p>Logically, we have the following:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+-------------+  out  +---+     +---+     +---+       +--------+
|             |------&gt;|   |----&gt;|   |----&gt;|   |------&gt;|        |
| Application |       | A |     | B |     | C |       | Driver |
|             |&lt;------|   |&lt;----|   |&lt;----|   |&lt;------|        |
+-------------+  in   +---+     +---+     +---+       +--------+

                      \                       /
                       +----------o----------+
                                  |
                               sessions
</pre></div>
</div>
<p>For outgoing messages, the driver receives the result of</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>    C.outgoing(B.outgoing(A.outgoing(message)))

or, [A, B, C].reduce(((m, ext) =&gt; ext.outgoing(m)), message)
</pre></div>
</div>
<p>For incoming messages, the application receives the result of</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>    A.incoming(B.incoming(C.incoming(message)))

or, [C, B, A].reduce(((m, ext) =&gt; ext.incoming(m)), message)
</pre></div>
</div>
<p>A session is of the following type, to borrow notation from pseudo-Haskell:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>type Session = {
  incoming :: Message -&gt; Message
  outgoing :: Message -&gt; Message
  close    :: () -&gt; ()
}
</pre></div>
</div>
<p>(That <code class="docutils literal notranslate"><span class="pre">()</span> <span class="pre">-&gt;</span> <span class="pre">()</span></code> syntax is intended to mean that <code class="docutils literal notranslate"><span class="pre">close()</span></code> is a nullary void
method; I apologise to any Haskell readers for not using the right monad.)</p>
<p>The <code class="docutils literal notranslate"><span class="pre">incoming()</span></code> and <code class="docutils literal notranslate"><span class="pre">outgoing()</span></code> methods perform message transformation in the
respective directions; <code class="docutils literal notranslate"><span class="pre">close()</span></code> is called when a socket closes so the session
can release any resources it’s holding, for example a DEFLATE de/compression
context.</p>
<p>However because this is JavaScript, the <code class="docutils literal notranslate"><span class="pre">incoming()</span></code> and <code class="docutils literal notranslate"><span class="pre">outgoing()</span></code> methods
may be asynchronous (indeed, <code class="docutils literal notranslate"><span class="pre">permessage-deflate</span></code> is based on <code class="docutils literal notranslate"><span class="pre">zlib</span></code>, whose API
is stream-based). So their interface is strictly:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>type Session = {
  incoming :: Message -&gt; Callback -&gt; ()
  outgoing :: Message -&gt; Callback -&gt; ()
  close    :: () -&gt; ()
}

type Callback = Either Error Message -&gt; ()
</pre></div>
</div>
<p>This means a message <em>m2</em> can be pushed into a session while it’s still
processing the preceding message <em>m1</em>. The messages can be processed
concurrently but they <em>must</em> be given to the next session in line (or to the
application) in the same order they came in. Applications will expect to receive
messages in the order they arrived over the wire, and sessions require this too.
So ordering of messages must be preserved throughout the pipeline.</p>
<p>Consider the following highly simplified extension that deflates messages on the
wire. <code class="docutils literal notranslate"><span class="pre">message</span></code> is a value conforming the type:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>type Message = {
  rsv1   :: Boolean
  rsv2   :: Boolean
  rsv3   :: Boolean
  opcode :: Number
  data   :: Buffer
}
</pre></div>
</div>
<p>Here’s the extension:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">zlib</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;zlib&#39;</span><span class="p">);</span>

<span class="kd">var</span><span class="w"> </span><span class="nx">deflate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">outgoing</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="nx">callback</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">zlib</span><span class="p">.</span><span class="nx">deflateRaw</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">message</span><span class="p">.</span><span class="nx">rsv1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">      </span><span class="nx">message</span><span class="p">.</span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">result</span><span class="p">;</span>
<span class="w">      </span><span class="nx">callback</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">},</span>

<span class="w">  </span><span class="nx">incoming</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="nx">callback</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// decompress inbound messages (elided)</span>
<span class="w">  </span><span class="p">},</span>

<span class="w">  </span><span class="nx">close</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// no state to clean up</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<p>We can call it with a large message followed by a small one, and the small one
will be returned first:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">crypto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;crypto&#39;</span><span class="p">),</span>
<span class="w">    </span><span class="nx">large</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nx">crypto</span><span class="p">.</span><span class="nx">randomBytes</span><span class="p">(</span><span class="mf">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mf">14</span><span class="p">),</span>
<span class="w">    </span><span class="nx">small</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Buffer</span><span class="p">(</span><span class="s1">&#39;hi&#39;</span><span class="p">);</span>

<span class="nx">deflate</span><span class="p">.</span><span class="nx">outgoing</span><span class="p">({</span><span class="w"> </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="nx">large</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;large&#39;</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">deflate</span><span class="p">.</span><span class="nx">outgoing</span><span class="p">({</span><span class="w"> </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="nx">small</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;small&#39;</span><span class="p">);</span>
<span class="p">});</span>

<span class="cm">/* prints:  2 &#39;small&#39;</span>
<span class="cm">            1 &#39;large&#39; */</span>
</pre></div>
</div>
<p>So a session that processes messages asynchronously may fail to preserve message
ordering.</p>
<p>Now, this extension is stateless, so it can process messages in any order and
still produce the same output. But some extensions are stateful and require
message order to be preserved.</p>
<p>For example, when using <code class="docutils literal notranslate"><span class="pre">permessage-deflate</span></code> without <code class="docutils literal notranslate"><span class="pre">no_context_takeover</span></code> set,
the session retains a DEFLATE de/compression context between messages, which
accumulates state as it consumes data (later messages can refer to sections of
previous ones to improve compression). Reordering parts of the DEFLATE stream
will result in a failed decompression. Messages must be decompressed in the same
order they were compressed by the peer in order for the DEFLATE protocol to
work.</p>
<p>Finally, there is the problem of closing a socket. When a WebSocket is closed by
the application, or receives a closing request from the other peer, there may be
messages outgoing from the application and incoming from the peer in the
pipeline. If we close the socket and pipeline immediately, two problems arise:</p>
<ul class="simple">
<li><p>We may send our own closing frame to the peer before all prior messages we
sent have been written to the socket, and before we have finished processing
all prior messages from the peer</p></li>
<li><p>The session may be instructed to close its resources (e.g. its de/compression
context) while it’s in the middle of processing a message, or before it has
received messages that are upstream of it in the pipeline</p></li>
</ul>
<p>Essentially, we must defer closing the sessions and sending a closing frame
until after all prior messages have exited the pipeline.</p>
</section>
<section id="design-goals">
<h2>Design goals<a class="headerlink" href="#design-goals" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>Message order must be preserved between the protocol driver, the extension
sessions, and the application</p></li>
<li><p>Messages should be handed off to sessions and endpoints as soon as possible,
to maximise throughput of stateless sessions</p></li>
<li><p>The closing procedure should block any further messages from entering the
pipeline, and should allow all existing messages to drain</p></li>
<li><p>Sessions should be closed as soon as possible to prevent them holding memory
and other resources when they have no more messages to handle</p></li>
<li><p>The closing API should allow the caller to detect when the pipeline is empty
and it is safe to continue the WebSocket closing procedure</p></li>
<li><p>Individual extensions should remain as simple as possible to facilitate
modularity and independent authorship</p></li>
</ul>
<p>The final point about modularity is an important one: this framework is designed
to facilitate extensions existing as plugins, by decoupling the protocol driver,
extensions, and application. In an ideal world, plugins should only need to
contain code for their specific functionality, and not solve these problems that
apply to all sessions. Also, solving some of these problems requires
consideration of all active sessions collectively, which an individual session
is incapable of doing.</p>
<p>For example, it is entirely possible to take the simple <code class="docutils literal notranslate"><span class="pre">deflate</span></code> extension
above and wrap its <code class="docutils literal notranslate"><span class="pre">incoming()</span></code> and <code class="docutils literal notranslate"><span class="pre">outgoing()</span></code> methods in two <code class="docutils literal notranslate"><span class="pre">Transform</span></code>
streams, producing this type:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>type Session = {
  incoming :: TransformStream
  outtoing :: TransformStream
  close    :: () -&gt; ()
}
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">Transform</span></code> class makes it easy to wrap an async function such that message
order is preserved:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">stream</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;stream&#39;</span><span class="p">),</span>
<span class="w">    </span><span class="nx">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">stream</span><span class="p">.</span><span class="nx">Transform</span><span class="p">({</span><span class="w"> </span><span class="nx">objectMode</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">});</span>

<span class="nx">session</span><span class="p">.</span><span class="nx">_transform</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">callback</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">self</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">;</span>
<span class="w">  </span><span class="nx">deflate</span><span class="p">.</span><span class="nx">outgoing</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">self</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
<span class="w">    </span><span class="nx">callback</span><span class="p">();</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">};</span>
</pre></div>
</div>
<p>However, this has a negative impact on throughput: it works by deferring
<code class="docutils literal notranslate"><span class="pre">callback()</span></code> until the async function has ‘returned’, which blocks <code class="docutils literal notranslate"><span class="pre">Transform</span></code>
from passing further input into the <code class="docutils literal notranslate"><span class="pre">_transform()</span></code> method until the current
message is dealt with completely. This would prevent sessions from processing
messages concurrently, and would unnecessarily reduce the throughput of
stateless extensions.</p>
<p>So, input should be handed off to sessions as soon as possible, and all we need
is a mechanism to reorder the output so that message order is preserved for the
next session in line.</p>
</section>
<section id="solution">
<h2>Solution<a class="headerlink" href="#solution" title="Permalink to this headline">#</a></h2>
<p>We now describe the model implemented here and how it meets the above design
goals. The above diagram where a stack of extensions sit between the driver and
application describes the data flow, but not the object graph. That looks like
this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>        +--------+
        | Driver |
        +---o----+
            |
            V
      +------------+      +----------+
      | Extensions o-----&gt;| Pipeline |
      +------------+      +-----o----+
                                |
                +---------------+---------------+
                |               |               |
          +-----o----+    +-----o----+    +-----o----+
          | Cell [A] |    | Cell [B] |    | Cell [C] |
          +----------+    +----------+    +----------+
</pre></div>
</div>
<p>A driver using this framework holds an instance of the <code class="docutils literal notranslate"><span class="pre">Extensions</span></code> class, which
it uses to register extension plugins, negotiate headers and transform messages.
The <code class="docutils literal notranslate"><span class="pre">Extensions</span></code> instance itself holds a <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code>, which contains an array of
<code class="docutils literal notranslate"><span class="pre">Cell</span></code> objects, each of which wraps one of the sessions.</p>
<section id="message-processing">
<h3>Message processing<a class="headerlink" href="#message-processing" title="Permalink to this headline">#</a></h3>
<p>Both the <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code> and <code class="docutils literal notranslate"><span class="pre">Cell</span></code> classes have <code class="docutils literal notranslate"><span class="pre">incoming()</span></code> and <code class="docutils literal notranslate"><span class="pre">outgoing()</span></code>
methods; the <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code> interface pushes messages into the pipe, delegates the
message to each <code class="docutils literal notranslate"><span class="pre">Cell</span></code> in turn, then returns it back to the driver. Outgoing
messages pass through <code class="docutils literal notranslate"><span class="pre">A</span></code> then <code class="docutils literal notranslate"><span class="pre">B</span></code> then <code class="docutils literal notranslate"><span class="pre">C</span></code>, and incoming messages in the
reverse order.</p>
<p>Internally, a <code class="docutils literal notranslate"><span class="pre">Cell</span></code> contains two <code class="docutils literal notranslate"><span class="pre">Functor</span></code> objects. A <code class="docutils literal notranslate"><span class="pre">Functor</span></code> wraps an async
function and makes sure its output messages maintain the order of its input
messages. This name is due to <a class="reference external" href="https://github.com/fronx">&#64;fronx</a>, on the basis
that, by preserving message order, the abstraction preserves the <em>mapping</em>
between input and output messages. To use our simple <code class="docutils literal notranslate"><span class="pre">deflate</span></code> extension from
above:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">functor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Functor</span><span class="p">(</span><span class="nx">deflate</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;outgoing&#39;</span><span class="p">);</span>

<span class="nx">functor</span><span class="p">.</span><span class="nx">call</span><span class="p">({</span><span class="w"> </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="nx">large</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;large&#39;</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">functor</span><span class="p">.</span><span class="nx">call</span><span class="p">({</span><span class="w"> </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="nx">small</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;small&#39;</span><span class="p">);</span>
<span class="p">});</span>

<span class="cm">/*  -&gt;  1 &#39;large&#39;</span>
<span class="cm">        2 &#39;small&#39; */</span>
</pre></div>
</div>
<p>A <code class="docutils literal notranslate"><span class="pre">Cell</span></code> contains two of these, one for each direction:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>                        +-----------------------+
                  +----&gt;| Functor [A, incoming] |
+----------+      |     +-----------------------+
| Cell [A] o------+
+----------+      |     +-----------------------+
                  +----&gt;| Functor [A, outgoing] |
                        +-----------------------+
</pre></div>
</div>
<p>This satisfies the message transformation requirements: the <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code> simply
loops over the cells in the appropriate direction to transform each message.
Because each <code class="docutils literal notranslate"><span class="pre">Cell</span></code> will preserve message order, we can pass a message to the
next <code class="docutils literal notranslate"><span class="pre">Cell</span></code> in line as soon as the current <code class="docutils literal notranslate"><span class="pre">Cell</span></code> returns it. This gives each
<code class="docutils literal notranslate"><span class="pre">Cell</span></code> all the messages in order while maximising throughput.</p>
</section>
<section id="session-closing">
<h3>Session closing<a class="headerlink" href="#session-closing" title="Permalink to this headline">#</a></h3>
<p>We want to close each session as soon as possible, after all existing messages
have drained. To do this, each <code class="docutils literal notranslate"><span class="pre">Cell</span></code> begins with a pending message counter in
each direction, labelled <code class="docutils literal notranslate"><span class="pre">in</span></code> and <code class="docutils literal notranslate"><span class="pre">out</span></code> below.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>                          +----------+
                          | Pipeline |
                          +-----o----+
                                |
                +---------------+---------------+
                |               |               |
          +-----o----+    +-----o----+    +-----o----+
          | Cell [A] |    | Cell [B] |    | Cell [C] |
          +----------+    +----------+    +----------+
             in: 0           in: 0           in: 0
            out: 0          out: 0          out: 0
</pre></div>
</div>
<p>When a message <em>m1</em> enters the pipeline, say in the <code class="docutils literal notranslate"><span class="pre">outgoing</span></code> direction, we
increment the <code class="docutils literal notranslate"><span class="pre">pending.out</span></code> counter on all cells immediately.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>                          +----------+
                    m1 =&gt; | Pipeline |
                          +-----o----+
                                |
                +---------------+---------------+
                |               |               |
          +-----o----+    +-----o----+    +-----o----+
          | Cell [A] |    | Cell [B] |    | Cell [C] |
          +----------+    +----------+    +----------+
             in: 0           in: 0           in: 0
            out: 1          out: 1          out: 1
</pre></div>
</div>
<p><em>m1</em> is handed off to <code class="docutils literal notranslate"><span class="pre">A</span></code>, meanwhile a second message <code class="docutils literal notranslate"><span class="pre">m2</span></code> arrives in the same
direction. All <code class="docutils literal notranslate"><span class="pre">pending.out</span></code> counters are again incremented.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>                          +----------+
                    m2 =&gt; | Pipeline |
                          +-----o----+
                                |
                +---------------+---------------+
            m1  |               |               |
          +-----o----+    +-----o----+    +-----o----+
          | Cell [A] |    | Cell [B] |    | Cell [C] |
          +----------+    +----------+    +----------+
             in: 0           in: 0           in: 0
            out: 2          out: 2          out: 2
</pre></div>
</div>
<p>When the first cell’s <code class="docutils literal notranslate"><span class="pre">A.outgoing</span></code> functor finishes processing <em>m1</em>, the first
<code class="docutils literal notranslate"><span class="pre">pending.out</span></code> counter is decremented and <em>m1</em> is handed off to cell <code class="docutils literal notranslate"><span class="pre">B</span></code>.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>                          +----------+
                          | Pipeline |
                          +-----o----+
                                |
                +---------------+---------------+
            m2  |           m1  |               |
          +-----o----+    +-----o----+    +-----o----+
          | Cell [A] |    | Cell [B] |    | Cell [C] |
          +----------+    +----------+    +----------+
             in: 0           in: 0           in: 0
            out: 1          out: 2          out: 2
</pre></div>
</div>
<p>As <code class="docutils literal notranslate"><span class="pre">B</span></code> finishes with <em>m1</em>, and as <code class="docutils literal notranslate"><span class="pre">A</span></code> finishes with <em>m2</em>, the <code class="docutils literal notranslate"><span class="pre">pending.out</span></code>
counters continue to decrement.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>                          +----------+
                          | Pipeline |
                          +-----o----+
                                |
                +---------------+---------------+
                |           m2  |           m1  |
          +-----o----+    +-----o----+    +-----o----+
          | Cell [A] |    | Cell [B] |    | Cell [C] |
          +----------+    +----------+    +----------+
             in: 0           in: 0           in: 0
            out: 0          out: 1          out: 2
</pre></div>
</div>
<p>Say <code class="docutils literal notranslate"><span class="pre">C</span></code> is a little slow, and begins processing <em>m2</em> while still processing
<em>m1</em>. That’s fine, the <code class="docutils literal notranslate"><span class="pre">Functor</span></code> mechanism will keep <em>m1</em> ahead of <em>m2</em> in the
output.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>                          +----------+
                          | Pipeline |
                          +-----o----+
                                |
                +---------------+---------------+
                |               |           m2  | m1
          +-----o----+    +-----o----+    +-----o----+
          | Cell [A] |    | Cell [B] |    | Cell [C] |
          +----------+    +----------+    +----------+
             in: 0           in: 0           in: 0
            out: 0          out: 0          out: 2
</pre></div>
</div>
<p>Once all messages are dealt with, the counters return to <code class="docutils literal notranslate"><span class="pre">0</span></code>.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>                          +----------+
                          | Pipeline |
                          +-----o----+
                                |
                +---------------+---------------+
                |               |               |
          +-----o----+    +-----o----+    +-----o----+
          | Cell [A] |    | Cell [B] |    | Cell [C] |
          +----------+    +----------+    +----------+
             in: 0           in: 0           in: 0
            out: 0          out: 0          out: 0
</pre></div>
</div>
<p>The same process applies in the <code class="docutils literal notranslate"><span class="pre">incoming</span></code> direction, the only difference being
that messages are passed to <code class="docutils literal notranslate"><span class="pre">C</span></code> first.</p>
<p>This makes closing the sessions quite simple. When the driver wants to close the
socket, it calls <code class="docutils literal notranslate"><span class="pre">Pipeline.close()</span></code>. This <em>immediately</em> calls <code class="docutils literal notranslate"><span class="pre">close()</span></code> on all
the cells. If a cell has <code class="docutils literal notranslate"><span class="pre">in</span> <span class="pre">==</span> <span class="pre">out</span> <span class="pre">==</span> <span class="pre">0</span></code>, then it immediately calls
<code class="docutils literal notranslate"><span class="pre">session.close()</span></code>. Otherwise, it stores the closing call and defers it until
<code class="docutils literal notranslate"><span class="pre">in</span></code> and <code class="docutils literal notranslate"><span class="pre">out</span></code> have both ticked down to zero. The pipeline will not accept new
messages after <code class="docutils literal notranslate"><span class="pre">close()</span></code> has been called, so we know the pending counts will not
increase after this point.</p>
<p>This means each session is closed as soon as possible: <code class="docutils literal notranslate"><span class="pre">A</span></code> can close while the
slow <code class="docutils literal notranslate"><span class="pre">C</span></code> session is still working, because it knows there are no more messages
on the way. Similarly, <code class="docutils literal notranslate"><span class="pre">C</span></code> will defer closing if <code class="docutils literal notranslate"><span class="pre">close()</span></code> is called while <em>m1</em>
is still in <code class="docutils literal notranslate"><span class="pre">B</span></code>, and <em>m2</em> in <code class="docutils literal notranslate"><span class="pre">A</span></code>, because its pending count means it knows it
has work yet to do, even if it’s not received those messages yet. This concern
cannot be addressed by extensions acting only on their own local state, unless
we pollute individual extensions by making them all implement this same
mechanism.</p>
<p>The actual closing API at each level is slightly different:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>type Session = {
  close :: () -&gt; ()
}

type Cell = {
  close :: () -&gt; Promise ()
}

type Pipeline = {
  close :: Callback -&gt; ()
}
</pre></div>
</div>
<p>This might appear inconsistent so it’s worth explaining. Remember that a
<code class="docutils literal notranslate"><span class="pre">Pipeline</span></code> holds a list of <code class="docutils literal notranslate"><span class="pre">Cell</span></code> objects, each wrapping a <code class="docutils literal notranslate"><span class="pre">Session</span></code>. The driver
talks (via the <code class="docutils literal notranslate"><span class="pre">Extensions</span></code> API) to the <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code> interface, and it wants
<code class="docutils literal notranslate"><span class="pre">Pipeline.close()</span></code> to do two things: close all the sessions, and tell me when
it’s safe to start the closing procedure (i.e. when all messages have drained
from the pipe and been handed off to the application or socket). A callback API
works well for that.</p>
<p>At the other end of the stack, <code class="docutils literal notranslate"><span class="pre">Session.close()</span></code> is a nullary void method with
no callback or promise API because we don’t care what it does, and whatever it
does do will not block the WebSocket protocol; we’re not going to hold off
processing messages while a session closes its de/compression context. We just
tell it to close itself, and don’t want to wait while it does that.</p>
<p>In the middle, <code class="docutils literal notranslate"><span class="pre">Cell.close()</span></code> returns a promise rather than using a callback.
This is for two reasons. First, <code class="docutils literal notranslate"><span class="pre">Cell.close()</span></code> might not do anything
immediately, it might have to defer its effect while messages drain. So, if
given a callback, it would have to store it in a queue for later execution.
Callbacks work fine if your method does something and can then invoke the
callback itself, but if you need to store callbacks somewhere so another method
can execute them, a promise is a better fit. Second, it better serves the
purposes of <code class="docutils literal notranslate"><span class="pre">Pipeline.close()</span></code>: it wants to call <code class="docutils literal notranslate"><span class="pre">close()</span></code> on each of a list of
cells, and wait for all of them to finish. This is simple and idiomatic using
promises:</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">closed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cells</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">cell</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">cell</span><span class="p">.</span><span class="nx">close</span><span class="p">());</span>
<span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">closed</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
</pre></div>
</div>
<p>(We don’t actually use a full <em>Promises/A+</em> compatible promise here, we use a
much simplified construction that acts as a callback aggregater and resolves
synchronously and does not support chaining, but the principle is the same.)</p>
</section>
<section id="error-handling">
<h3>Error handling<a class="headerlink" href="#error-handling" title="Permalink to this headline">#</a></h3>
<p>We’ve not mentioned error handling so far but it bears some explanation. The
above counter system still applies, but behaves slightly differently in the
presence of errors.</p>
<p>Say we push three messages into the pipe in the outgoing direction:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>                          +----------+
            m3, m2, m1 =&gt; | Pipeline |
                          +-----o----+
                                |
                +---------------+---------------+
                |               |               |
          +-----o----+    +-----o----+    +-----o----+
          | Cell [A] |    | Cell [B] |    | Cell [C] |
          +----------+    +----------+    +----------+
             in: 0           in: 0           in: 0
            out: 3          out: 3          out: 3
</pre></div>
</div>
<p>They pass through the cells successfully up to this point:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>                          +----------+
                          | Pipeline |
                          +-----o----+
                                |
                +---------------+---------------+
            m3  |           m2  |           m1  |
          +-----o----+    +-----o----+    +-----o----+
          | Cell [A] |    | Cell [B] |    | Cell [C] |
          +----------+    +----------+    +----------+
             in: 0           in: 0           in: 0
            out: 1          out: 2          out: 3
</pre></div>
</div>
<p>At this point, session <code class="docutils literal notranslate"><span class="pre">B</span></code> produces an error while processing <em>m2</em>, that is <em>m2</em>
becomes <em>e2</em>. <em>m1</em> is still in the pipeline, and <em>m3</em> is queued behind <em>m2</em>.
What ought to happen is that <em>m1</em> is handed off to the socket, then <em>m2</em> is
released to the driver, which will detect the error and begin closing the
socket. No further processing should be done on <em>m3</em> and it should not be
released to the driver after the error is emitted.</p>
<p>To handle this, we allow errors to pass down the pipeline just like messages do,
to maintain ordering. But, once a cell sees its session produce an error, or it
receives an error from upstream, it should refuse to accept any further
messages. Session <code class="docutils literal notranslate"><span class="pre">B</span></code> might have begun processing <em>m3</em> by the time it produces
the error <em>e2</em>, but <code class="docutils literal notranslate"><span class="pre">C</span></code> will have been given <em>e2</em> before it receives <em>m3</em>, and
can simply drop <em>m3</em>.</p>
<p>Now, say <em>e2</em> reaches the slow session <code class="docutils literal notranslate"><span class="pre">C</span></code> while <em>m1</em> is still present,
meanwhile <em>m3</em> has been dropped. <code class="docutils literal notranslate"><span class="pre">C</span></code> will never receive <em>m3</em> since it will have
been dropped upstream. Under the present model, its <code class="docutils literal notranslate"><span class="pre">out</span></code> counter will be <code class="docutils literal notranslate"><span class="pre">3</span></code>
but it is only going to emit two more values: <em>m1</em> and <em>e2</em>. In order for
closing to work, we need to decrement <code class="docutils literal notranslate"><span class="pre">out</span></code> to reflect this. The situation
should look like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>                          +----------+
                          | Pipeline |
                          +-----o----+
                                |
                +---------------+---------------+
                |               |           e2  | m1
          +-----o----+    +-----o----+    +-----o----+
          | Cell [A] |    | Cell [B] |    | Cell [C] |
          +----------+    +----------+    +----------+
             in: 0           in: 0           in: 0
            out: 0          out: 0          out: 2
</pre></div>
</div>
<p>When a cell sees its session emit an error, or when it receives an error from
upstream, it sets its pending count in the appropriate direction to equal the
number of messages it is <em>currently</em> processing. It will not accept any messages
after it sees the error, so this will allow the counter to reach zero.</p>
<p>Note that while <em>e2</em> is in the pipeline, <code class="docutils literal notranslate"><span class="pre">Pipeline</span></code> should drop any further
messages in the outgoing direction, but should continue to accept incoming
messages. Until <em>e2</em> makes it out of the pipe to the driver, behind previous
successful messages, the driver does not know an error has happened, and a
message may arrive over the socket and make it all the way through the incoming
pipe in the meantime. We only halt processing in the affected direction to avoid
doing unnecessary work since messages arriving after an error should not be
processed.</p>
<p>Some unnecessary work may happen, for example any messages already in the
pipeline following <em>m2</em> will be processed by <code class="docutils literal notranslate"><span class="pre">A</span></code>, since it’s upstream of the
error. Those messages will be dropped by <code class="docutils literal notranslate"><span class="pre">B</span></code>.</p>
</section>
</section>
<section id="alternative-ideas">
<h2>Alternative ideas<a class="headerlink" href="#alternative-ideas" title="Permalink to this headline">#</a></h2>
<p>I am considering implementing <code class="docutils literal notranslate"><span class="pre">Functor</span></code> as an object-mode transform stream
rather than what is essentially an async function. Being object-mode, a stream
would preserve message boundaries and would also possibly help address
back-pressure. I’m not sure whether this would require external API changes so
that such streams could be connected to the downstream driver’s streams.</p>
</section>
<section id="acknowledgements">
<h2>Acknowledgements<a class="headerlink" href="#acknowledgements" title="Permalink to this headline">#</a></h2>
<p>Credit is due to <a class="reference external" href="https://github.com/mnowster">&#64;mnowster</a> for helping with the
design and to <a class="reference external" href="https://github.com/fronx">&#64;fronx</a> for helping name things.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./reveal/node_modules/websocket-extensions/lib/pipeline"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Mark S. Baldwin<br/>
  
      &copy; Copyright 2023.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>